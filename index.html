<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bisnis Rafah - Laporan Transaksi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library untuk PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        ::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.4); }
        .btn-type-active { background-color: white !important; color: #2563eb !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl min-h-screen relative pb-28">

    <!-- Konfigurasi API -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxLB-Ltq2xoXPrGNfrTymBWtogixXGVbXVNsPLoo5IRHBEBpuWANXbk4jXK7BK-LDvg/exec"; 
    </script>

    <!-- Header -->
    <header class="px-8 pt-10 pb-6 flex justify-between items-center bg-white rounded-b-[3rem] shadow-sm">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tighter uppercase">Bisnis Rafah</h1>
            <div class="flex items-center gap-1.5 mt-1">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Laporan Keuangan</p>
            </div>
        </div>
        <div class="w-12 h-12 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg border-4 border-white">
            <i data-lucide="wallet" class="w-5 h-5"></i>
        </div>
    </header>

    <main id="main-content" class="p-6">
        <!-- Tab Beranda -->
        <section id="dashboard" class="tab-content active space-y-6">
            <!-- Saldo Card -->
            <div class="bg-gradient-to-br from-slate-900 to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/20 rounded-full -mr-20 -mt-20 blur-3xl"></div>
                <div class="relative z-10">
                    <p class="opacity-70 text-xs font-medium mb-1 uppercase tracking-widest">Saldo Bersih</p>
                    <h2 id="total-balance" class="text-3xl font-black mb-8">Rp 0</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="switchTab('history', 'Income')" class="bg-white/10 backdrop-blur-md p-4 rounded-[1.5rem] border border-white/10 cursor-pointer active:scale-95 transition-all">
                            <div class="flex items-center gap-2 text-emerald-400 text-[10px] mb-1 font-bold uppercase tracking-wider">
                                <i data-lucide="trending-up" class="w-3"></i> Masuk
                            </div>
                            <p id="total-income" class="text-sm font-bold truncate">Rp 0</p>
                        </div>
                        <div onclick="switchTab('history', 'Expense')" class="bg-white/10 backdrop-blur-md p-4 rounded-[1.5rem] border border-white/10 cursor-pointer active:scale-95 transition-all">
                            <div class="flex items-center gap-2 text-rose-400 text-[10px] mb-1 font-bold uppercase tracking-wider">
                                <i data-lucide="trending-down" class="w-3"></i> Keluar
                            </div>
                            <p id="total-expense" class="text-sm font-bold truncate">Rp 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grafik Tren -->
            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-xs uppercase tracking-wider">
                    <i data-lucide="line-chart" class="text-blue-500 w-4"></i> Analisis Arus Kas
                </h3>
                <canvas id="trendChart" height="200"></canvas>
            </div>

            <!-- Grafik Pie -->
            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-xs uppercase tracking-wider">
                    <i data-lucide="pie-chart" class="text-indigo-500 w-4"></i> Distribusi Kategori
                </h3>
                <canvas id="pieChart" height="250"></canvas>
            </div>

            <!-- Kalender -->
            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xs font-bold text-slate-800 flex items-center gap-2 uppercase tracking-wider">
                        <i data-lucide="calendar" class="text-blue-500 w-4"></i> Arus Harian
                    </h2>
                    <div id="current-month" class="text-[10px] font-black text-slate-400 bg-slate-50 px-3 py-1 rounded-full">...</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1.5"></div>
            </div>
        </section>

        <!-- Tab Tambah -->
        <section id="add" class="tab-content space-y-6">
            <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl border border-slate-50">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black text-slate-800">Catat Baru</h2>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                        <button onclick="setFormType('Income')" id="type-income" class="px-5 py-2 rounded-xl text-xs font-black transition-all btn-type-active uppercase">Masuk</button>
                        <button onclick="setFormType('Expense')" id="type-expense" class="px-5 py-2 rounded-xl text-xs font-black transition-all text-slate-500 uppercase">Keluar</button>
                    </div>
                </div>
                <form id="transaction-form" class="space-y-5">
                    <input list="categories" id="cat-input" required class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 focus:bg-white focus:border-blue-500 transition-all outline-none font-bold" placeholder="Kategori...">
                    <datalist id="categories">
                        <option value="Modal Investor"><option value="Keuntungan"><option value="Bahan Baku"><option value="Alat & Material"><option value="Operasional"><option value="Gaji & Upah">
                    </datalist>
                    
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-400">Rp</span>
                        <input type="number" id="amount-input" required class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 pl-12 text-2xl font-black text-slate-800 focus:bg-white focus:border-blue-500 transition-all outline-none" placeholder="0">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="date-input" class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 text-sm font-bold outline-none">
                        <label class="w-full bg-slate-50 flex items-center justify-center p-4 rounded-2xl cursor-pointer border-2 border-dashed border-slate-200 hover:bg-slate-100">
                            <span id="file-label" class="text-[10px] text-slate-400 font-black flex items-center gap-2"><i data-lucide="camera" class="w-3"></i> Bukti</span>
                            <input type="file" id="file-input" class="hidden" accept="image/*,application/pdf">
                        </label>
                    </div>
                    
                    <textarea id="desc-input" class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 outline-none text-sm font-medium" rows="3" placeholder="Tambahkan keterangan detail di sini..."></textarea>
                    
                    <button type="submit" id="btn-save" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl active:scale-95 transition-all">Simpan Transaksi</button>
                </form>
            </div>
        </section>

        <!-- Tab Riwayat -->
        <section id="history" class="tab-content space-y-6">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-xl font-black text-slate-800">Riwayat</h2>
                <div class="flex gap-2">
                    <button onclick="exportPDF()" class="p-3 bg-rose-100 text-rose-700 rounded-xl" title="Download PDF"><i data-lucide="file-text" class="w-4 h-4"></i></button>
                    <button onclick="exportCSV()" class="p-3 bg-emerald-100 text-emerald-700 rounded-xl" title="Download CSV"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                </div>
            </div>
            
            <!-- Filter Riwayat -->
            <div class="flex gap-2 px-2 overflow-x-auto pb-2 no-scrollbar">
                <button onclick="filterHistory('All')" id="filter-all" class="px-5 py-2 bg-blue-600 text-white rounded-full text-[10px] font-black whitespace-nowrap">SEMUA</button>
                <button onclick="filterHistory('Income')" id="filter-income" class="px-5 py-2 bg-white text-slate-400 border border-slate-100 rounded-full text-[10px] font-black whitespace-nowrap">MASUK</button>
                <button onclick="filterHistory('Expense')" id="filter-expense" class="px-5 py-2 bg-white text-slate-400 border border-slate-100 rounded-full text-[10px] font-black whitespace-nowrap">KELUAR</button>
            </div>

            <div id="history-list" class="space-y-4"></div>
        </section>
    </main>

    <!-- Modal PIN -->
    <div id="pin-modal" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl text-center space-y-6">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto"><i data-lucide="lock" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-black text-slate-800">Sandi Keamanan</h3>
            <input type="password" id="pin-input" inputmode="numeric" maxlength="6" class="w-full text-center text-3xl font-black tracking-[0.4em] p-4 bg-slate-50 border-2 rounded-2xl outline-none" placeholder="••••••">
            <div class="grid grid-cols-2 gap-4 pt-4">
                <button onclick="togglePinModal(false)" class="py-4 font-black text-slate-400 text-sm">BATAL</button>
                <button onclick="verifyAndSubmit()" class="bg-blue-600 text-white py-4 rounded-2xl font-black text-sm">KONFIRMASI</button>
            </div>
        </div>
    </div>

    <!-- Navigasi Bawah -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md glass-nav shadow-2xl rounded-[2.5rem] py-3 px-8 z-40 flex justify-between items-center">
        <button onclick="switchTab('dashboard')" class="nav-btn text-blue-600 flex flex-col items-center gap-1" data-tab="dashboard">
            <i data-lucide="layout-grid" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase">Beranda</span>
        </button>
        <button onclick="switchTab('add')" id="nav-add" class="bg-blue-600 w-14 h-14 rounded-2xl -mt-12 flex items-center justify-center text-white shadow-xl active:scale-90 transition-all border-4 border-white">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>
        <button onclick="switchTab('history')" class="nav-btn text-slate-300 flex flex-col items-center gap-1" data-tab="history">
            <i data-lucide="list-checks" class="w-5 h-5"></i>
            <span class="text-[9px] font-black uppercase">Riwayat</span>
        </button>
    </nav>

    <script>
        let transactions = [];
        let currentType = 'Income';
        let currentHistoryFilter = 'All';
        let fileData = { name: '', data: null };
        let trendChart = null;
        let pieChart = null;
        const REQUIRED_PIN = "112211";

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('date-input').valueAsDate = new Date();
            fetchData();
        };

        async function fetchData() {
            try {
                const response = await fetch(`${API_URL}?action=getData`);
                transactions = await response.json();
                updateDashboard();
                updateHistory();
            } catch (e) { console.error("Gagal ambil data", e); }
        }

        function switchTab(id, filter = 'All') {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                const active = b.getAttribute('data-tab') === id;
                b.classList.toggle('text-blue-600', active);
                b.classList.toggle('text-slate-300', !active);
            });

            if (id === 'dashboard') updateDashboard();
            if (id === 'history') filterHistory(filter);
            window.scrollTo(0,0);
        }

        function updateDashboard() {
            const inc = transactions.filter(t => t.Tipe === 'Income').reduce((s, t) => s + Number(t.Jumlah), 0);
            const exp = transactions.filter(t => t.Tipe === 'Expense').reduce((s, t) => s + Number(t.Jumlah), 0);
            
            document.getElementById('total-balance').innerText = `Rp ${(inc - exp).toLocaleString('id-ID')}`;
            document.getElementById('total-income').innerText = `Rp ${inc.toLocaleString('id-ID')}`;
            document.getElementById('total-expense').innerText = `Rp ${exp.toLocaleString('id-ID')}`;
            
            renderCharts();
            renderCalendar();
        }

        function renderCharts() {
            // Trend Chart (Line Chart dengan 2 Garis)
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            // Ambil 7 hari terakhir unik
            const last7Days = [...new Set(transactions.map(t => t.Tanggal))].sort().slice(-7);
            
            const incomeData = last7Days.map(date => 
                transactions.filter(t => t.Tanggal === date && t.Tipe === 'Income').reduce((s, t) => s + Number(t.Jumlah), 0)
            );
            const expenseData = last7Days.map(date => 
                transactions.filter(t => t.Tanggal === date && t.Tipe === 'Expense').reduce((s, t) => s + Number(t.Jumlah), 0)
            );

            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => d.split('-')[2]),
                    datasets: [
                        { 
                            label: 'Masuk',
                            data: incomeData, 
                            borderColor: '#10b981', 
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true, tension: 0.4, borderWeight: 3
                        },
                        { 
                            label: 'Keluar',
                            data: expenseData, 
                            borderColor: '#ef4444', 
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true, tension: 0.4, borderWeight: 3
                        }
                    ]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } }, 
                        y: { display: false } 
                    } 
                }
            });

            // Pie Chart (Distribusi Kategori)
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            if (pieChart) pieChart.destroy();

            const categories = {};
            transactions.forEach(t => {
                categories[t.Kategori] = (categories[t.Kategori] || 0) + Number(t.Jumlah);
            });

            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                        borderWidth: 5,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } 
                    },
                    cutout: '70%'
                }
            });
        }

        function renderCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            document.getElementById('current-month').innerText = today.toLocaleString('id-ID', { month: 'long', year: 'numeric' });

            for (let i = 1; i <= lastDay; i++) {
                // Perbaikan Format Tanggal ISO agar akurat dengan data database
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const dayTxs = transactions.filter(t => {
                    // Normalisasi format tanggal (menghapus jam jika ada)
                    const tDate = t.Tanggal.split('T')[0];
                    return tDate === dateStr;
                });

                const i_val = dayTxs.filter(t => t.Tipe === 'Income').reduce((s, t) => s + Number(t.Jumlah), 0);
                const e_val = dayTxs.filter(t => t.Tipe === 'Expense').reduce((s, t) => s + Number(t.Jumlah), 0);
                
                const isToday = i === today.getDate();
                const div = document.createElement('div');
                div.className = `min-h-[50px] p-1 flex flex-col items-center justify-center rounded-xl border transition-all ${isToday ? 'border-blue-500 bg-blue-50' : 'border-slate-50'} ${dayTxs.length > 0 ? 'bg-white shadow-sm' : 'opacity-40'}`;
                
                div.innerHTML = `
                    <span class="font-bold text-[8px] mb-1 ${isToday ? 'text-blue-600' : 'text-slate-400'}">${i}</span>
                    ${i_val > 0 ? `<span class="text-emerald-500 text-[6px] font-black">+${Math.round(i_val/1000)}k</span>`:''}
                    ${e_val > 0 ? `<span class="text-rose-500 text-[6px] font-black">-${Math.round(e_val/1000)}k</span>`:''}
                `;
                grid.appendChild(div);
            }
        }

        function updateHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            let filtered = [...transactions];
            if (currentHistoryFilter !== 'All') {
                filtered = filtered.filter(t => t.Tipe === currentHistoryFilter);
            }

            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-center py-20 opacity-20 font-black text-xs tracking-widest">TIDAK ADA DATA</div>';
                return;
            }

            filtered.sort((a,b) => new Date(b.Tanggal) - new Date(a.Tanggal)).forEach(t => {
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-[2rem] shadow-sm border border-slate-50 flex flex-col gap-3";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="p-3 rounded-2xl ${t.Tipe === 'Income' ? 'bg-emerald-50 text-emerald-500' : 'bg-rose-50 text-rose-500'}">
                                <i data-lucide="${t.Tipe === 'Income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-black text-[11px] uppercase tracking-tight text-slate-800">${t.Kategori}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase">${new Date(t.Tanggal).toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'})}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-sm ${t.Tipe === 'Income' ? 'text-emerald-500' : 'text-rose-500'}">
                                ${t.Tipe === 'Income' ? '+' : '-'} Rp ${Number(t.Jumlah).toLocaleString('id-ID')}
                            </p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <p class="text-[10px] text-slate-500 font-medium leading-relaxed italic">"${t.Keterangan || 'Tanpa keterangan'}"</p>
                    </div>
                    ${t.URL_Struk ? `
                        <a href="${t.URL_Struk}" target="_blank" class="text-[9px] font-black text-blue-600 flex items-center gap-1.5 self-end hover:underline">
                            <i data-lucide="image" class="w-3 h-3"></i> LIHAT BUKTI STRUK
                        </a>
                    ` : ''}
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        // Fitur Export PDF dengan jsPDF
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Laporan Transaksi Bisnis Rafah", 14, 20);
            doc.setFontSize(10);
            doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 14, 28);

            const tableData = transactions.map(t => [
                t.Tanggal,
                t.Tipe === 'Income' ? 'MASUK' : 'KELUAR',
                t.Kategori,
                `Rp ${Number(t.Jumlah).toLocaleString('id-ID')}`,
                t.Keterangan
            ]);

            doc.autoTable({
                head: [['Tanggal', 'Tipe', 'Kategori', 'Jumlah', 'Keterangan']],
                body: tableData,
                startY: 35,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [37, 99, 235] }
            });

            doc.save(`Laporan_Rafah_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportCSV() {
            if (transactions.length === 0) return alert("Tidak ada data");
            let csv = "Tanggal,Tipe,Kategori,Jumlah,Keterangan\n";
            transactions.forEach(t => {
                csv += `${t.Tanggal},${t.Tipe},${t.Kategori},${t.Jumlah},"${t.Keterangan}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Laporan_Rafah_${new Date().toLocaleDateString()}.csv`;
            a.click();
        }

        // Fungsi Form & Modal
        function setFormType(t) { 
            currentType = t;
            document.getElementById('type-income').className = t === 'Income' ? "px-5 py-2 rounded-xl text-xs font-black transition-all btn-type-active" : "px-5 py-2 rounded-xl text-xs font-black transition-all text-slate-500";
            document.getElementById('type-expense').className = t === 'Expense' ? "px-5 py-2 rounded-xl text-xs font-black transition-all btn-type-active" : "px-5 py-2 rounded-xl text-xs font-black transition-all text-slate-500";
        }

        function filterHistory(type) {
            currentHistoryFilter = type;
            ['all', 'income', 'expense'].forEach(b => {
                const btn = document.getElementById(`filter-${b}`);
                btn.className = (b === type.toLowerCase()) 
                    ? "px-5 py-2 bg-blue-600 text-white rounded-full text-[10px] font-black whitespace-nowrap" 
                    : "px-5 py-2 bg-white text-slate-400 border border-slate-100 rounded-full text-[10px] font-black whitespace-nowrap";
            });
            updateHistory();
        }

        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    fileData = { name: file.name, data: f.target.result };
                    document.getElementById('file-label').innerText = "File Terlampir";
                };
                reader.readAsDataURL(file);
            }
        };

        function togglePinModal(s) { 
            document.getElementById('pin-modal').classList.toggle('hidden', !s);
            if(!s) document.getElementById('pin-input').value = "";
        }

        document.getElementById('transaction-form').onsubmit = (e) => { 
            e.preventDefault(); 
            togglePinModal(true); 
        };

        async function verifyAndSubmit() {
            if (document.getElementById('pin-input').value !== REQUIRED_PIN) return alert("PIN SALAH!");
            
            togglePinModal(false);
            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "Mengirim...";

            const payload = {
                type: currentType,
                category: document.getElementById('cat-input').value,
                amount: document.getElementById('amount-input').value,
                date: document.getElementById('date-input').value,
                description: document.getElementById('desc-input').value,
                fileName: fileData.name,
                fileData: fileData.data
            };

            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("Data Berhasil Disimpan!");
                document.getElementById('transaction-form').reset();
                fileData = { name: '', data: null };
                document.getElementById('file-label').innerHTML = '<i data-lucide="camera" class="w-3"></i> Bukti';
                switchTab('dashboard');
                fetchData();
            } catch (e) {
                alert("Gagal: " + e.toString());
            } finally {
                btn.disabled = false; btn.innerText = "Simpan Transaksi";
            }
        }
    </script>
</body>
</html>

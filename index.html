<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bisnis Rafah - Laporan Transaksi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        ::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl min-h-screen relative pb-24">

    <!-- Konfigurasi API -->
    <script>
        // GANTI URL DI BAWAH INI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        const API_URL = "https://script.google.com/macros/s/AKfycbxLB-Ltq2xoXPrGNfrTymBWtogixXGVbXVNsPLoo5IRHBEBpuWANXbk4jXK7BK-LDvg/exec"; 
    </script>

    <!-- Header -->
    <header class="px-8 pt-12 pb-8 flex justify-between items-center bg-white rounded-b-[3rem] shadow-sm">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tighter uppercase">Bisnis Rafah</h1>
            <div class="flex items-center gap-1.5 mt-1">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Laporan Transaksi</p>
            </div>
        </div>
        <div class="w-14 h-14 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-3xl flex items-center justify-center text-white shadow-lg shadow-blue-200 border-4 border-white">
            <i data-lucide="wallet"></i>
        </div>
    </header>

    <main id="main-content" class="p-6">
        <!-- Tab Beranda -->
        <section id="dashboard" class="tab-content active space-y-6">
            <div class="bg-gradient-to-br from-slate-900 to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/20 rounded-full -mr-20 -mt-20 blur-3xl"></div>
                <div class="relative z-10">
                    <p class="opacity-70 text-sm font-medium mb-1">Total Saldo Bersih</p>
                    <h2 id="total-balance" class="text-3xl font-black mb-8">Rp 0</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/10 backdrop-blur-xl p-4 rounded-[1.5rem] border border-white/10">
                            <div class="flex items-center gap-2 text-emerald-400 text-[10px] mb-1 font-bold uppercase tracking-wider">
                                <i data-lucide="trending-up" class="w-3"></i> Pemasukan
                            </div>
                            <p id="total-income" class="text-sm font-bold truncate">Rp 0</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-xl p-4 rounded-[1.5rem] border border-white/10">
                            <div class="flex items-center gap-2 text-rose-400 text-[10px] mb-1 font-bold uppercase tracking-wider">
                                <i data-lucide="trending-down" class="w-3"></i> Pengeluaran
                            </div>
                            <p id="total-expense" class="text-sm font-bold truncate">Rp 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wider">
                    <i data-lucide="line-chart" class="text-blue-500 w-4"></i> Tren Terakhir
                </h3>
                <canvas id="trendChart" height="200"></canvas>
            </div>

            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2 uppercase tracking-wider">
                        <i data-lucide="calendar" class="text-blue-500 w-4"></i> Arus Harian
                    </h2>
                    <div id="current-month" class="text-[10px] font-black text-slate-400 bg-slate-50 px-3 py-1 rounded-full">...</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1.5"></div>
            </div>
        </section>

        <!-- Tab Tambah -->
        <section id="add" class="tab-content space-y-6">
            <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black text-slate-800">Catat Baru</h2>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                        <button onclick="setFormType('Income')" id="type-income" class="px-5 py-2 rounded-xl text-xs font-black transition-all bg-white text-blue-600 shadow-md">MASUK</button>
                        <button onclick="setFormType('Expense')" id="type-expense" class="px-5 py-2 rounded-xl text-xs font-black transition-all text-slate-500">KELUAR</button>
                    </div>
                </div>
                <form id="transaction-form" class="space-y-6">
                    <input list="categories" id="cat-input" required class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 focus:bg-white focus:border-blue-500 transition-all outline-none font-bold" placeholder="Kategori...">
                    <datalist id="categories">
                        <option value="Modal Investor"><option value="Keuntungan"><option value="Bahan Baku"><option value="Alat & Material"><option value="Operasional">
                    </datalist>
                    <input type="number" id="amount-input" required class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 text-2xl font-black text-slate-800 focus:bg-white focus:border-blue-500 transition-all outline-none" placeholder="Nominal Rp">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="date-input" class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 text-sm font-bold outline-none">
                        <label class="w-full bg-slate-50 flex items-center justify-center p-4 rounded-2xl cursor-pointer border-2 border-dashed border-slate-200">
                            <span id="file-label" class="text-[10px] text-slate-400 font-black"><i data-lucide="camera"></i></span>
                            <input type="file" id="file-input" class="hidden" accept="image/*,application/pdf">
                        </label>
                    </div>
                    <textarea id="desc-input" class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 outline-none" rows="2" placeholder="Keterangan..."></textarea>
                    <button type="submit" id="btn-save" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl active:scale-95 transition-all">Simpan</button>
                </form>
            </div>
        </section>

        <!-- Tab Riwayat -->
        <section id="history" class="tab-content space-y-6">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-xl font-black text-slate-800">Riwayat</h2>
                <div class="flex gap-2">
                    <a id="drive-link" href="#" target="_blank" class="p-3 bg-blue-100 text-blue-700 rounded-xl"><i data-lucide="folder-open" class="w-4 h-4"></i></a>
                    <button onclick="exportCSV()" class="p-3 bg-emerald-100 text-emerald-700 rounded-xl"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div id="history-list" class="space-y-4"></div>
        </section>
    </main>

    <!-- Modal PIN -->
    <div id="pin-modal" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl text-center space-y-6">
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-[2rem] flex items-center justify-center mx-auto"><i data-lucide="lock" class="w-10 h-10"></i></div>
            <h3 class="text-2xl font-black text-slate-800">Sandi Keamanan</h3>
            <input type="password" id="pin-input" inputmode="numeric" maxlength="6" class="w-full text-center text-4xl font-black tracking-[0.4em] p-5 bg-slate-50 border-2 rounded-[1.5rem] outline-none" placeholder="••••••">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="togglePinModal(false)" class="py-4 font-black text-slate-400">BATAL</button>
                <button onclick="verifyAndSubmit()" class="bg-blue-600 text-white py-4 rounded-2xl font-black">KONFIRMASI</button>
            </div>
        </div>
    </div>

    <!-- Navigasi -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md glass-nav shadow-2xl rounded-[2.5rem] py-3 px-8 z-40 flex justify-between items-center">
        <button onclick="switchTab('dashboard')" class="nav-btn text-blue-600 flex flex-col items-center" data-tab="dashboard">
            <i data-lucide="trending-up" class="w-6 h-6 stroke-[3px]"></i>
            <span class="text-[9px] font-black uppercase">Beranda</span>
        </button>
        <button onclick="switchTab('add')" class="bg-blue-600 w-16 h-16 rounded-[1.8rem] -mt-14 flex items-center justify-center text-white shadow-2xl active:scale-90 transition-all">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>
        <button onclick="switchTab('history')" class="nav-btn text-slate-300 flex flex-col items-center" data-tab="history">
            <i data-lucide="history" class="w-6 h-6"></i>
            <span class="text-[9px] font-black uppercase">Riwayat</span>
        </button>
    </nav>

    <script>
        let transactions = [];
        let currentType = 'Income';
        let fileData = { name: '', data: null };
        let trendChart = null;
        const REQUIRED_PIN = "112211";

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('date-input').valueAsDate = new Date();
            if (API_URL === "MASUKKAN_URL_WEB_APP_DI_SINI") {
                alert("PENTING: Masukkan API URL dari Google Apps Script ke dalam kode HTML!");
            } else {
                fetchData();
                fetchConfig();
            }
        };

        async function fetchConfig() {
            try {
                const response = await fetch(`${API_URL}?action=getConfig`);
                const config = await response.json();
                document.getElementById('drive-link').href = config.folderUrl;
            } catch (e) { console.error("Gagal ambil config", e); }
        }

        async function fetchData() {
            try {
                const response = await fetch(`${API_URL}?action=getData`);
                transactions = await response.json();
                updateDashboard();
                updateHistory();
            } catch (e) { console.error("Gagal ambil data", e); }
        }

        async function verifyAndSubmit() {
            const pin = document.getElementById('pin-input').value;
            if (pin !== REQUIRED_PIN) {
                alert("Sandi Salah!");
                return;
            }

            togglePinModal(false);
            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "Mengirim...";

            const payload = {
                type: currentType,
                category: document.getElementById('cat-input').value,
                amount: document.getElementById('amount-input').value,
                date: document.getElementById('date-input').value,
                description: document.getElementById('desc-input').value,
                fileName: fileData.name,
                fileData: fileData.data
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Penting untuk GAS POST
                    body: JSON.stringify(payload)
                });
                // Karena mode 'no-cors', kita tidak bisa baca response body secara langsung, 
                // tapi data biasanya tetap masuk ke GAS.
                setTimeout(() => {
                    btn.disabled = false; btn.innerText = "Simpan Sekarang";
                    alert("Permintaan Terkirim! Silakan refresh data beberapa saat lagi.");
                    document.getElementById('transaction-form').reset();
                    switchTab('dashboard');
                    fetchData();
                }, 2000);
            } catch (e) {
                alert("Gagal kirim data: " + e.toString());
                btn.disabled = false;
            }
        }

        // --- UI Logic (Sama seperti sebelumnya namun disesuaikan untuk API) ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                const active = b.getAttribute('data-tab') === id;
                b.classList.toggle('text-blue-600', active);
                b.classList.toggle('text-slate-300', !active);
            });
            if (id === 'dashboard') updateDashboard();
        }

        function togglePinModal(s) { document.getElementById('pin-modal').classList.toggle('hidden', !s); }
        function setFormType(t) { currentType = t; }

        function updateDashboard() {
            const inc = transactions.filter(t => t.Tipe === 'Income').reduce((s, t) => s + Number(t.Jumlah), 0);
            const exp = transactions.filter(t => t.Tipe === 'Expense').reduce((s, t) => s + Number(t.Jumlah), 0);
            document.getElementById('total-balance').innerText = `Rp ${(inc - exp).toLocaleString('id-ID')}`;
            document.getElementById('total-income').innerText = `Rp ${inc.toLocaleString('id-ID')}`;
            document.getElementById('total-expense').innerText = `Rp ${exp.toLocaleString('id-ID')}`;
            renderChart();
            renderCalendar();
        }

        function renderChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            const lastData = transactions.slice(-7);
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: lastData.map(t => t.Tanggal.split('-')[2]),
                    datasets: [{ data: lastData.map(t => t.Jumlah), borderColor: '#3b82f6', fill: true, tension: 0.4 }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        function renderCalendar() {
            const today = new Date();
            const days = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            document.getElementById('current-month').innerText = today.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            for (let i = 1; i <= days; i++) {
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayTxs = transactions.filter(t => t.Tanggal === dateStr);
                const i_val = dayTxs.filter(t => t.Tipe === 'Income').reduce((s, t) => s + Number(t.Jumlah), 0);
                const e_val = dayTxs.filter(t => t.Tipe === 'Expense').reduce((s, t) => s + Number(t.Jumlah), 0);
                const div = document.createElement('div');
                div.className = `min-h-[50px] p-1 flex flex-col items-center justify-center rounded-xl border ${dayTxs.length > 0 ? 'bg-white border-blue-100 shadow-sm' : 'border-transparent opacity-40'}`;
                div.innerHTML = `<span class="font-bold text-[8px]">${i}</span>${i_val > 0 ? `<span class="text-emerald-500 text-[6px]">+${i_val/1000}k</span>`:''}${e_val > 0 ? `<span class="text-rose-500 text-[6px]">-${e_val/1000}k</span>`:''}`;
                grid.appendChild(div);
            }
        }

        function updateHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...transactions].reverse().forEach(t => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-[1.5rem] shadow-sm flex justify-between items-center";
                div.innerHTML = `<div><p class="font-black text-[10px] uppercase">${t.Kategori}</p><p class="text-[8px] text-slate-400">${t.Tanggal}</p></div><div class="text-right"><p class="font-black text-xs ${t.Tipe === 'Income' ? 'text-emerald-500' : 'text-rose-500'}">Rp ${Number(t.Jumlah).toLocaleString()}</p></div>`;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (f) => {
                    fileData = { name: file.name, data: f.target.result };
                    document.getElementById('file-label').innerText = "Terlampir";
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('transaction-form').onsubmit = (e) => { e.preventDefault(); togglePinModal(true); };
    </script>
</body>
</html>
